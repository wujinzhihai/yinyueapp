// entry/src/main/ets/services/PlayerService.ets

import { media } from '@kit.MediaKit'
import { Song } from '../models/Song'

/**
 * éŸ³ä¹æ’­æ”¾æœåŠ¡ - å•ä¾‹æ¨¡å¼
 * âŒ ç§»é™¤ @ObservedV2 - å› ä¸ºä¼šå¯¼è‡´ @State å†²çª
 */
export class PlayerService {
  private static instance: PlayerService
  private avPlayer: media.AVPlayer | null = null

  // ========== æ’­æ”¾çŠ¶æ€ (ä¸ä½¿ç”¨è£…é¥°å™¨) ==========
  currentSong: Song | null = null
  isPlaying: boolean = false
  currentTime: number = 0
  duration: number = 0
  playlist: Song[] = []
  currentIndex: number = -1

  // çŠ¶æ€å˜åŒ–å›è°ƒ
  onStateChange: (() => void) | null = null

  private constructor() {
    this.initPlayer()
  }

  static getInstance(): PlayerService {
    if (!PlayerService.instance) {
      PlayerService.instance = new PlayerService()
    }
    return PlayerService.instance
  }

  private async initPlayer(): Promise<void> {
    try {
      this.avPlayer = await media.createAVPlayer()
      console.info('[PlayerService] âœ… AVPlayer åˆå§‹åŒ–æˆåŠŸ')

      this.avPlayer.on('stateChange', (state) => {
        console.info(`[PlayerService] çŠ¶æ€å˜åŒ–: ${state}`)
      })

      this.avPlayer.on('endOfStream', () => {
        console.info('[PlayerService] æ’­æ”¾å®Œæˆ')
        this.playNext()
      })

      this.avPlayer.on('durationUpdate', (duration) => {
        this.duration = duration
        this.notifyStateChange()
        console.info(`[PlayerService] æ—¶é•¿: ${this.formatTime(duration)}`)
      })

      this.avPlayer.on('timeUpdate', (time) => {
        this.currentTime = time
        this.notifyStateChange()
      })

      this.avPlayer.on('error', (err) => {
        console.error('[PlayerService] âŒ æ’­æ”¾é”™è¯¯:', JSON.stringify(err))
        this.playNext()
      })

    } catch (err) {
      console.error('[PlayerService] âŒ åˆå§‹åŒ–å¤±è´¥:', JSON.stringify(err))
    }
  }

  setPlaylist(songs: Song[]): void {
    this.playlist = songs
    console.info(`[PlayerService] æ’­æ”¾åˆ—è¡¨å·²è®¾ç½®: ${songs.length} é¦–æ­Œæ›²`)
  }

  async playSong(song: Song, index?: number): Promise<void> {
    if (!this.avPlayer) {
      console.error('[PlayerService] âŒ æ’­æ”¾å™¨æœªåˆå§‹åŒ–')
      return
    }

    try {
      console.info(`[PlayerService] ğŸµ å¼€å§‹æ’­æ”¾: ${song.name}`)

      await this.avPlayer.reset()

      this.currentSong = song
      this.currentIndex = index ?? this.playlist.findIndex(s => s.id === song.id)

      // âœ… ä½¿ç”¨ audioUrl
      const songUrl: string = song.audioUrl
      this.avPlayer.url = songUrl
      await this.avPlayer.prepare()
      await this.avPlayer.play()

      this.isPlaying = true
      this.notifyStateChange()
      console.info('[PlayerService] âœ… æ’­æ”¾æˆåŠŸ')

    } catch (err) {
      console.error('[PlayerService] âŒ æ’­æ”¾å¤±è´¥:', JSON.stringify(err))
      this.isPlaying = false
      this.notifyStateChange()
    }
  }

  async togglePlay(): Promise<void> {
    if (!this.avPlayer || !this.currentSong) return

    try {
      if (this.isPlaying) {
        await this.avPlayer.pause()
        this.isPlaying = false
        console.info('[PlayerService] â¸ å·²æš‚åœ')
      } else {
        await this.avPlayer.play()
        this.isPlaying = true
        console.info('[PlayerService] â–¶ å·²æ’­æ”¾')
      }
      this.notifyStateChange()
    } catch (err) {
      console.error('[PlayerService] âŒ åˆ‡æ¢å¤±è´¥:', JSON.stringify(err))
    }
  }

  async playPrevious(): Promise<void> {
    if (this.playlist.length === 0) return

    const prevIndex = this.currentIndex > 0 ? this.currentIndex - 1 : this.playlist.length - 1
    await this.playSong(this.playlist[prevIndex], prevIndex)
  }

  async playNext(): Promise<void> {
    if (this.playlist.length === 0) return

    const nextIndex = this.currentIndex < this.playlist.length - 1 ? this.currentIndex + 1 : 0
    await this.playSong(this.playlist[nextIndex], nextIndex)
  }

  async seekTo(time: number): Promise<void> {
    if (!this.avPlayer) return

    try {
      await this.avPlayer.seek(time)
      this.currentTime = time
      this.notifyStateChange()
      console.info(`[PlayerService] è·³è½¬åˆ°: ${this.formatTime(time)}`)
    } catch (err) {
      console.error('[PlayerService] âŒ è·³è½¬å¤±è´¥:', JSON.stringify(err))
    }
  }

  formatTime(ms: number): string {
    const seconds = Math.floor(ms / 1000)
    const mins = Math.floor(seconds / 60)
    const secs = seconds % 60
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }

  async release(): Promise<void> {
    if (this.avPlayer) {
      await this.avPlayer.release()
      this.avPlayer = null
      console.info('[PlayerService] ğŸ”š æ’­æ”¾å™¨å·²é‡Šæ”¾')
    }
  }

  // é€šçŸ¥çŠ¶æ€å˜åŒ–
  private notifyStateChange(): void {
    if (this.onStateChange) {
      this.onStateChange()
    }
  }
}
