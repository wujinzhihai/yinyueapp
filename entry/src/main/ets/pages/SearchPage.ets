import { SearchBar } from '../components/SearchBar'
import { SongListItem } from '../components/SongListItem'
import { MusicApiService } from '../services/MusicApiService'
import { Song } from '../models/Song'

/**
 * æœç´¢é¡µé¢ - æ”¯æŒçƒ­é—¨æ¨èå’Œæœç´¢åŠŸèƒ½
 */
@Entry
@Component
struct SearchPage {
  @State songList: Song[] = []
  @State isLoading: boolean = false
  @State errorMessage: string = ''
  @State isSearchMode: boolean = false

  /**
   * é¡µé¢åŠ è½½æ—¶è·å–çƒ­é—¨æ­Œæ›²
   */
  async aboutToAppear(): Promise<void> {
    console.info('[SearchPage] é¡µé¢åŠ è½½')
    await this.loadHotSongs()
  }

  /**
   * åŠ è½½çƒ­é—¨æ­Œæ›²
   */
  async loadHotSongs(): Promise<void> {
    this.isLoading = true
    this.errorMessage = ''
    this.isSearchMode = false

    try {
      console.info('[SearchPage] å¼€å§‹åŠ è½½çƒ­é—¨æ­Œæ›²')
      const songs: Song[] = await MusicApiService.getHotSongs(20)
      this.songList = songs
      console.info(`[SearchPage] çƒ­é—¨æ­Œæ›²åŠ è½½å®Œæˆï¼Œå…± ${songs.length} é¦–`)

      if (songs.length === 0) {
        this.errorMessage = 'æš‚æ— æ¨èæ­Œæ›²'
      }
    } catch (e) {
      let errorMsg: string = 'åŠ è½½å¤±è´¥'
      if (e instanceof Error) {
        errorMsg = e.message
      } else if (typeof e === 'string') {
        errorMsg = e
      } else if (e !== null && e !== undefined) {
        errorMsg = String(e)
      }

      console.error(`[SearchPage] çƒ­é—¨æ­Œæ›²åŠ è½½å¤±è´¥: ${errorMsg}`)
      this.errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•'
    } finally {
      this.isLoading = false
    }
  }

  /**
   * æ‰§è¡Œæœç´¢
   */
  async handleSearch(keyword: string): Promise<void> {
    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤çƒ­é—¨æ­Œæ›²
    if (!keyword || keyword.trim() === '') {
      await this.loadHotSongs()
      return
    }

    this.isLoading = true
    this.errorMessage = ''
    this.songList = []
    this.isSearchMode = true

    try {
      console.info(`[SearchPage] å¼€å§‹æœç´¢: ${keyword}`)
      const songs: Song[] = await MusicApiService.searchSongs(keyword, 20)
      this.songList = songs
      console.info(`[SearchPage] æœç´¢å®Œæˆï¼Œå…± ${songs.length} é¦–æ­Œæ›²`)

      if (songs.length === 0) {
        this.errorMessage = 'æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²'
      }
    } catch (e) {
      let errorMsg: string = 'æœªçŸ¥é”™è¯¯'
      if (e instanceof Error) {
        errorMsg = e.message
      } else if (typeof e === 'string') {
        errorMsg = e
      } else if (e !== null && e !== undefined) {
        errorMsg = String(e)
      }

      console.error(`[SearchPage] æœç´¢å¤±è´¥: ${errorMsg}`)
      this.errorMessage = `æœç´¢å¤±è´¥: ${errorMsg}`
    } finally {
      this.isLoading = false
    }
  }

  /**
   * æ­Œæ›²é¡¹ç‚¹å‡»äº‹ä»¶
   */
  handleSongClick(song: Song): void {
    console.info(`[SearchPage] ç‚¹å‡»æ­Œæ›²: ${song.name}`)
    // TODO: ä¸‹é˜¶æ®µå®ç°æ’­æ”¾åŠŸèƒ½
  }

  build() {
    Column() {
      // æœç´¢æ 
      SearchBar({
        onSearch: (keyword: string) => {
          this.handleSearch(keyword)
        }
      })

      // æ ‡é¢˜æ ï¼ˆä»…åœ¨æ¨èæ¨¡å¼æ˜¾ç¤ºï¼‰
      if (!this.isSearchMode && !this.isLoading && this.songList.length > 0) {
        Row() {
          Text('ğŸ”¥ çƒ­é—¨æ¨è')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .width('100%')
        .height(48)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)
        .alignItems(VerticalAlign.Center)
      }

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#1890FF')
          Text(this.isSearchMode ? 'æœç´¢ä¸­...' : 'åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
      } else if (this.errorMessage !== '') {
        // é”™è¯¯çŠ¶æ€
        Column() {
          Text('ğŸ˜•')
            .fontSize(48)
            .margin({ bottom: 12 })
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 20 })
          Button('é‡è¯•')
            .fontSize(14)
            .backgroundColor('#1890FF')
            .borderRadius(4)
            .padding({ left: 24, right: 24, top: 8, bottom: 8 })
            .onClick(() => {
              if (this.isSearchMode) {
                this.loadHotSongs()
              } else {
                this.loadHotSongs()
              }
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
      } else if (this.songList.length > 0) {
        // ç»“æœåˆ—è¡¨ï¼ˆâœ… ä¿®å¤ï¼šæ·»åŠ å®½é«˜ï¼‰
        List() {
          ForEach(this.songList, (song: Song) => {
            ListItem() {
              SongListItem({
                song: song,
                onItemClick: (clickedSong: Song) => {
                  this.handleSongClick(clickedSong)
                }
              })
            }
          }, (song: Song) => song.id.toString())
        }
        .width('100%')         // âœ… æ˜ç¡®æŒ‡å®šå®½åº¦
        .height('100%')        // âœ… æ˜ç¡®æŒ‡å®šé«˜åº¦
        .layoutWeight(1)
        .backgroundColor(Color.White)
        .divider({
          strokeWidth: 1,
          color: '#F0F0F0',
          startMargin: 16,
          endMargin: 16
        })
      } else {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸµ')
            .fontSize(48)
            .margin({ bottom: 12 })
          Text('æœç´¢ä½ å–œæ¬¢çš„æ­Œæ›²')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
