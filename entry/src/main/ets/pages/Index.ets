// entry/src/main/ets/pages/Index.ets
import { Song } from '../models/Song'
import { MusicApiService } from '../services/MusicApiService'
import { PlayerService } from '../services/PlayerService'
import { SongListItem } from '../components/SongListItem'
import { MiniPlayer } from '../components/MiniPlayer'
import { BusinessError } from '@ohos.base'
import http from '@ohos.net.http'
import router from '@ohos.router'

// âœ… æ¥å£å®šä¹‰ï¼ˆæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç‹¬ç«‹æ¥å£ï¼‰
interface PlaylistData {
  tracks?: Song[]
}
interface TestResponse {
  code: number
  playlist?: PlaylistData
}
@Entry
@Component
struct Index {
  @State songs: Song[] = []
  @State filteredSongs: Song[] = []
  @State searchText: string = ''
  @State isLoading: boolean = true
  @State isSearching: boolean = false
  @State errorMessage: string = ''
  @State searchMode: boolean = false
  private playerService: PlayerService = PlayerService.getInstance()
  @State playerStateVersion: number = 0
  private updateTimer: number = -1
  // âœ… ç½‘ç»œæµ‹è¯•æ–¹æ³•ï¼ˆä½¿ç”¨ä¸Šé¢å®šä¹‰çš„æ¥å£ï¼‰
  async testNetworkConnection(): Promise<void> {
    console.info('[TEST] ========== å¼€å§‹ç½‘ç»œæµ‹è¯• ==========')

    const testUrl = 'http://10.24.139.82:3000/playlist/detail?id=19723756'
    const httpRequest = http.createHttp()

    try {
      console.info(`[TEST] ğŸŒ æµ‹è¯•URL: ${testUrl}`)

      const response = await httpRequest.request(testUrl, {
        method: http.RequestMethod.GET,
        connectTimeout: 10000,
        readTimeout: 10000
      })

      console.info(`[TEST] âœ… çŠ¶æ€ç : ${response.responseCode}`)
      console.info(`[TEST] âœ… å“åº”ç±»å‹: ${typeof response.result}`)
      console.info(`[TEST] âœ… å“åº”é•¿åº¦: ${(response.result as string).length}`)
      console.info(`[TEST] âœ… å“åº”å‰100å­—ç¬¦: ${(response.result as string).substring(0, 100)}`)

      const data = JSON.parse(response.result as string) as TestResponse
      console.info(`[TEST] âœ… JSONè§£ææˆåŠŸ`)
      console.info(`[TEST] âœ… code: ${data.code}`)
      console.info(`[TEST] âœ… æ­Œæ›²æ•°é‡: ${data.playlist?.tracks?.length || 0}`)

    } catch (err) {
      console.error(`[TEST] âŒ è¯·æ±‚å¤±è´¥`)
      console.error(`[TEST] âŒ é”™è¯¯ç±»å‹: ${typeof err}`)
      console.error(`[TEST] âŒ é”™è¯¯å†…å®¹: ${JSON.stringify(err)}`)

      if (err && typeof err === 'object') {
        const error = err as BusinessError
        console.error(`[TEST] âŒ é”™è¯¯ç : ${error.code}`)
        console.error(`[TEST] âŒ é”™è¯¯æ¶ˆæ¯: ${error.message}`)
      }
    } finally {
      httpRequest.destroy()
    }
  }

  async aboutToAppear(): Promise<void> {
    console.info('[Index] ============ é¡µé¢å¯åŠ¨ ============')

    // âœ… å…ˆæ‰§è¡Œç½‘ç»œæµ‹è¯•
    await this.testNetworkConnection()

    // ç„¶ååŠ è½½æ­Œæ›²
    await this.loadHotSongs()
    this.startPlayerStateUpdate()
  }

  aboutToDisappear(): void {
    clearInterval(this.updateTimer)
  }

  private startPlayerStateUpdate(): void {
    this.updateTimer = setInterval(() => {
      this.playerStateVersion++
    }, 500)
  }

  async loadHotSongs(): Promise<void> {
    this.isLoading = true
    this.errorMessage = ''
    this.searchMode = false

    try {
      console.info('[Index] å¼€å§‹åŠ è½½çƒ­é—¨æ­Œæ›²...')
      const songs = await MusicApiService.getHotSongs()

      this.songs = songs
      this.filteredSongs = songs
      this.playerService.setPlaylist(songs)

      console.info(`[Index] âœ… åŠ è½½æˆåŠŸ: ${songs.length} é¦–æ­Œæ›²`)
    } catch (err) {
      this.errorMessage = 'åŠ è½½å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
      console.error('[Index] âŒ åŠ è½½å¤±è´¥:', JSON.stringify(err))
    } finally {
      this.isLoading = false
    }
  }

  async performOnlineSearch(keywords: string): Promise<void> {
    if (!keywords || keywords.trim() === '') {
      this.searchMode = false
      this.filteredSongs = this.songs
      return
    }

    this.isSearching = true
    this.searchMode = true
    console.info(`[Index] ğŸ” å¼€å§‹åœ¨çº¿æœç´¢: "${keywords}"`)

    try {
      const results = await MusicApiService.searchSongs(keywords)
      this.filteredSongs = results
      console.info(`[Index] âœ… æœç´¢æˆåŠŸ: ${results.length} é¦–æ­Œæ›²`)

      if (results.length > 0) {
        this.playerService.setPlaylist(results)
      }
    } catch (err) {
      console.error('[Index] âŒ æœç´¢å¤±è´¥:', JSON.stringify(err))
      this.filteredSongs = []
    } finally {
      this.isSearching = false
    }
  }

  onSearchSubmit(): void {
    const keywords = this.searchText.trim()
    if (keywords === '') {
      this.searchMode = false
      this.filteredSongs = this.songs
      console.info('[Index] æ¸…ç©ºæœç´¢ï¼Œæ˜¾ç¤ºçƒ­é—¨æ­Œæ›²')
    } else {
      this.performOnlineSearch(keywords)
    }
  }
  // âœ… æ­£ç¡®çš„ onSongClick æ–¹æ³•
  onSongClick(song: Song): void {
    const index = this.filteredSongs.findIndex(s => s.id === song.id)
    this.playerService.playSong(song, index)
    console.info(`[Index] ç‚¹å‡»æ’­æ”¾: ${song.name}`)

    // âœ… è·¯ç”±è·³è½¬
    router.pushUrl({
      url: 'pages/PlayerPage'
    }).catch((err: Error) => {
      console.error('[Index] âŒ è·¯ç”±è·³è½¬å¤±è´¥:', JSON.stringify(err))
    })
  }
  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        Text('ğŸµ éŸ³ä¹æ’­æ”¾å™¨')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .width('100%')
          .padding({ left: 20, right: 20, top: 20, bottom: 10 })

        Row() {
          TextInput({ placeholder: 'æœç´¢æ­Œæ›²ã€æ­Œæ‰‹', text: this.searchText })
            .layoutWeight(1)
            .backgroundColor('#F5F5F5')
            .borderRadius(20)
            .padding({ left: 15, right: 15 })
            .onChange((value: string) => {
              this.searchText = value
            })
            .onSubmit(() => {
              this.onSearchSubmit()
            })

          Button('ğŸ”')
            .fontSize(20)
            .backgroundColor('#FF1744')
            .fontColor('#FFFFFF')
            .width(50)
            .height(40)
            .margin({ left: 10 })
            .onClick(() => {
              this.onSearchSubmit()
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 15 })

        if (this.searchMode && !this.isSearching) {
          Row() {
            Text(`æœç´¢ "${this.searchText}"`)
              .fontSize(14)
              .fontColor('#666666')
            Button('è¿”å›çƒ­é—¨')
              .fontSize(12)
              .padding({ left: 10, right: 10, top: 5, bottom: 5 })
              .margin({ left: 10 })
              .onClick(() => {
                this.searchText = ''
                this.loadHotSongs()
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 10 })
        }

        if (this.isLoading || this.isSearching) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#FF1744')
            Text(this.isSearching ? 'æœç´¢ä¸­...' : 'åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ top: 10 })
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)

        } else if (this.errorMessage) {
          Column() {
            Text('âŒ')
              .fontSize(40)
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor('#999999')
              .margin({ top: 10 })
            Button('é‡æ–°åŠ è½½')
              .fontSize(14)
              .margin({ top: 20 })
              .onClick(() => {
                this.loadHotSongs()
              })
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)

        } else if (this.filteredSongs.length === 0) {
          Column() {
            Text('ğŸ”')
              .fontSize(40)
            Text(this.searchMode ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ­Œæ›²' : 'æš‚æ— æ­Œæ›²')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ top: 10 })
            if (this.searchMode) {
              Button('è¿”å›çƒ­é—¨')
                .fontSize(14)
                .margin({ top: 20 })
                .onClick(() => {
                  this.searchText = ''
                  this.loadHotSongs()
                })
            }
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)

        } else {
          List({ space: 8 }) {
            ForEach(this.filteredSongs, (song: Song) => {
              ListItem() {
                SongListItem({
                  song: song,
                  isPlaying: this.playerService.currentSong?.id === song.id && this.playerStateVersion >= 0,
                  onItemClick: (clickedSong: Song) => {
                    this.onSongClick(clickedSong)
                  }
                })
              }
            }, (song: Song) => song.id.toString())
          }
          .layoutWeight(1)
          .padding({ left: 15, right: 15, bottom: 100 })
          .scrollBar(BarState.Auto)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FAFAFA')

      if (this.playerService.currentSong && this.playerStateVersion >= 0) {
        MiniPlayer()
      }
    }
    .width('100%')
    .height('100%')
  }
}
