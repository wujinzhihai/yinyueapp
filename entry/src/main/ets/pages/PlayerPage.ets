// entry/src/main/ets/pages/PlayerPage.ets

import { PlayerService } from '../services/PlayerService'
import { Song } from '../models/Song'
import router from '@ohos.router'

@Entry
@Component
struct PlayerPage {
  @State currentSong: Song | null = null
  @State isPlaying: boolean = false
  @State currentTime: number = 0
  @State duration: number = 0

  private playerService: PlayerService = PlayerService.getInstance()
  private updateTimer: number = -1

  aboutToAppear(): void {
    console.info('[PlayerPage] é¡µé¢å¯åŠ¨')
    this.loadCurrentSong()
    this.startStateUpdate()
  }

  aboutToDisappear(): void {
    console.info('[PlayerPage] é¡µé¢é”€æ¯')
    clearInterval(this.updateTimer)
  }

  // âœ… å¯åŠ¨å®šæ—¶æ›´æ–°
  private startStateUpdate(): void {
    this.updateTimer = setInterval(() => {
      this.updatePlayerState()
    }, 500)
  }

  // âœ… æ›´æ–°æ’­æ”¾å™¨çŠ¶æ€
  private updatePlayerState(): void {
    this.currentSong = this.playerService.currentSong
    this.isPlaying = this.playerService.isPlaying
    // âœ… ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ currentTime å±æ€§ï¼ˆæ¯«ç§’è½¬ç§’ï¼‰
    this.currentTime = Math.floor(this.playerService.currentTime / 1000)

    if (this.currentSong) {
      this.duration = this.currentSong.duration
    }
  }

  private loadCurrentSong(): void {
    const song = this.playerService.currentSong
    if (song) {
      this.currentSong = song
      this.duration = song.duration
      console.info(`[PlayerPage] å½“å‰æ­Œæ›²: ${song.name}`)
    } else {
      console.warn('[PlayerPage] âš ï¸ æ— å½“å‰æ­Œæ›²')
    }
  }

  private handlePlayPause(): void {
    console.info('[PlayerPage] åˆ‡æ¢æ’­æ”¾çŠ¶æ€')
    this.playerService.togglePlay()
    this.isPlaying = this.playerService.isPlaying
  }

  private handlePrevious(): void {
    console.info('[PlayerPage] ä¸Šä¸€æ›²')
    this.playerService.playPrevious()
    this.loadCurrentSong()
  }

  private handleNext(): void {
    console.info('[PlayerPage] ä¸‹ä¸€æ›²')
    this.playerService.playNext()
    this.loadCurrentSong()
  }

  // âœ… è¿”å›é¦–é¡µ
  private handleBack(): void {
    router.back()
  }

  // âœ… ä¿®å¤ï¼šæ”¹ä¸º minutes æ¶ˆé™¤è­¦å‘Š
  private formatTime(seconds: number): string {
    const minutes = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return minutes.toString() + ':' + (secs < 10 ? '0' : '') + secs.toString()
  }

  build() {
    Column() {
      // âœ… é¡¶éƒ¨è¿”å›æŒ‰é’®
      Row() {
        Button('â† è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.handleBack())
      }
      .width('100%')
      .padding({ left: 20, top: 20, bottom: 10 })
      .justifyContent(FlexAlign.Start)

      if (this.currentSong) {
        Column() {
          // å°é¢
          Image(this.currentSong.coverUrl)
            .width(300)
            .height(300)
            .borderRadius(12)
            .margin({ top: 40, bottom: 40 })
            .alt($r('app.media.app_icon'))  // âœ… åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å›¾æ ‡

          // æ­Œæ›²ä¿¡æ¯
          Text(this.currentSong.name)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 8 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(this.currentSong.artist)
            .fontSize(16)
            .fontColor('#999999')
            .margin({ bottom: 40 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // è¿›åº¦æ¡
          Row() {
            Text(this.formatTime(this.currentTime))
              .fontSize(12)
              .fontColor('#999999')
              .width(45)

            Slider({
              value: this.currentTime,
              min: 0,
              max: this.duration > 0 ? this.duration : 1,
              step: 1
            })
              .layoutWeight(1)
              .margin({ left: 12, right: 12 })
              .trackColor('#E0E0E0')
              .selectedColor('#FF1744')

            Text(this.formatTime(this.duration))
              .fontSize(12)
              .fontColor('#999999')
              .width(45)
          }
          .width('90%')
          .margin({ bottom: 50 })

          // æ§åˆ¶æŒ‰é’®
          Row() {
            Button('â®ï¸')
              .fontSize(32)
              .backgroundColor(Color.Transparent)
              .fontColor('#333333')
              .onClick(() => this.handlePrevious())

            Button(this.isPlaying ? 'â¸ï¸' : 'â–¶ï¸')
              .fontSize(48)
              .backgroundColor('#FF1744')
              .fontColor('#FFFFFF')
              .width(80)
              .height(80)
              .borderRadius(40)
              .margin({ left: 40, right: 40 })
              .onClick(() => this.handlePlayPause())

            Button('â­ï¸')
              .fontSize(32)
              .backgroundColor(Color.Transparent)
              .fontColor('#333333')
              .onClick(() => this.handleNext())
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Start)
        .alignItems(HorizontalAlign.Center)

      } else {
        // æ— æ­Œæ›²æ—¶æ˜¾ç¤º
        Column() {
          Text('ğŸµ')
            .fontSize(60)
            .margin({ bottom: 20 })
          Text('æš‚æ— æ’­æ”¾æ­Œæ›²')
            .fontSize(18)
            .fontColor('#999999')
          Button('è¿”å›é¦–é¡µ')
            .fontSize(16)
            .margin({ top: 30 })
            .onClick(() => this.handleBack())
        }
        .layoutWeight(1)
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }
}
