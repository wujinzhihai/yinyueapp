import MusicApiService, { MusicItem } from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import { LyricParser, LyricLine } from '../utils/LyricParser';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct PlayerPage {
  @Watch('onSongChange')
  @StorageLink('currentSong') currentSong: MusicItem | null = null;
  @Watch('onPlayStateChange')
  @StorageLink('playState') playState: PlayState = PlayState.IDLE;
  @Watch('onTimeChange')
  @StorageLink('currentTime') currentTime: number = 0;
  @StorageLink('duration') duration: number = 0;
  @StorageLink('currentIndex') currentIndex: number = -1;
  @StorageLink('playlist') playlist: MusicItem[] = [];

  @State coverUrl: string = '';
  @State lyrics: LyricLine[] = [];
  @State currentLyricIndex: number = -1;
  @State selectedQuality: number = 320;
  @State isUserDragging: boolean = false;
  @State showQualityMenu: boolean = false;
  @State rotateAngle: number = 0;
  @State isRotating: boolean = false;

  private scroller: Scroller = new Scroller();
  private rotationTimer: number = -1;

  aboutToAppear(): void {
    console.info('[PlayerPage] ===== é¡µé¢åŠ è½½ =====');
    console.info('[PlayerPage] å½“å‰æ­Œæ›²:', this.currentSong?.name);
    console.info('[PlayerPage] æ’­æ”¾çŠ¶æ€:', this.playState);
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);

    if (this.playState === PlayState.PLAYING && this.currentSong) {
      setTimeout(() => {
        console.info('[PlayerPage] é¡µé¢åŠ è½½æ—¶å¯åŠ¨æ—‹è½¬');
        this.startRotation();
      }, 500);
    }
  }

  async onSongChange(): Promise<void> {
    console.info('[PlayerPage] ===== åˆ‡æ­Œè§¦å‘ =====');
    console.info('[PlayerPage] æ­Œæ›²å:', this.currentSong?.name);
    console.info('[PlayerPage] æ­Œæ›²ID:', this.currentSong?.id);
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);
    console.info('[PlayerPage] æ’­æ”¾çŠ¶æ€:', this.playState);

    // å…ˆåœæ­¢æ—‹è½¬
    this.stopRotation();
    this.coverUrl = '';

    if (this.currentSong?.picId && this.currentSong?.source) {
      try {
        const newCover = await MusicApiService.getPicUrl(
          this.currentSong.source,
          this.currentSong.picId,
          500
        );
        console.info('[PlayerPage] å°é¢åŠ è½½æˆåŠŸ');
        this.coverUrl = newCover;
      } catch (error) {
        const err = error as Error;
        console.error('[PlayerPage] è·å–å°é¢å¤±è´¥:', err.message);
        this.coverUrl = '';
      }
    }

    await this.loadLyrics();
    this.currentLyricIndex = -1;

    // ç§»é™¤å»¶è¿Ÿæ£€æŸ¥ï¼Œä¾èµ– onPlayStateChange è‡ªåŠ¨å¤„ç†
    console.info('[PlayerPage] åˆ‡æ­Œå®Œæˆï¼Œç­‰å¾…æ’­æ”¾çŠ¶æ€å˜åŒ–è§¦å‘æ—‹è½¬');
  }


  onPlayStateChange(): void {
    console.info('[PlayerPage] ===== æ’­æ”¾çŠ¶æ€å˜åŒ– =====');
    console.info('[PlayerPage] æ–°çŠ¶æ€:', this.playState);
    console.info('[PlayerPage] å½“å‰æ—‹è½¬çŠ¶æ€:', this.isRotating);

    if (this.playState === PlayState.PLAYING) {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸º PLAYINGï¼Œç«‹å³å¯åŠ¨æ—‹è½¬');
      // ç§»é™¤å»¶è¿Ÿï¼Œç«‹å³å¯åŠ¨
      this.startRotation();
    } else if (this.playState === PlayState.PAUSED) {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸º PAUSEDï¼Œåœæ­¢æ—‹è½¬');
      this.stopRotation();
    } else {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸ºå…¶ä»–:', this.playState);
      this.stopRotation();
    }
  }

  startRotation(): void {
    console.info('[PlayerPage] ===== startRotation è°ƒç”¨ =====');
    console.info('[PlayerPage] å½“å‰ isRotating:', this.isRotating);
    console.info('[PlayerPage] å½“å‰ rotateAngle:', this.rotateAngle);

    // å¦‚æœå·²ç»åœ¨æ—‹è½¬ï¼Œå…ˆåœæ­¢
    if (this.isRotating) {
      console.info('[PlayerPage] å·²åœ¨æ—‹è½¬ï¼Œå…ˆåœæ­¢å†é‡æ–°å¯åŠ¨');
      this.stopRotation();
    }

    this.isRotating = true;
    console.info('[PlayerPage] è®¾ç½® isRotating = true');

    // ç«‹å³é‡ç½®è§’åº¦ä¸º0
    this.rotateAngle = 0;
    console.info('[PlayerPage] é‡ç½®è§’åº¦ä¸º 0');

    // ä½¿ç”¨ nextTick ç¡®ä¿çŠ¶æ€æ›´æ–°åå†å¯åŠ¨åŠ¨ç”»
    setTimeout(() => {
      console.info('[PlayerPage] å¯åŠ¨æ— é™æ—‹è½¬åŠ¨ç”»');
      animateTo({
        duration: 20000,
        curve: Curve.Linear,
        iterations: -1,
        playMode: PlayMode.Normal,
        onFinish: () => {
          console.info('[PlayerPage] æ—‹è½¬åŠ¨ç”»å®Œæˆå›è°ƒï¼ˆä¸åº”è¯¥è¢«è°ƒç”¨ï¼‰');
        }
      }, () => {
        this.rotateAngle = 360;
        console.info('[PlayerPage] è®¾ç½®ç›®æ ‡è§’åº¦ 360');
      });
    }, 100);
  }


  stopRotation(): void {
    console.info('[PlayerPage] ===== stopRotation è°ƒç”¨ =====');
    console.info('[PlayerPage] å½“å‰è§’åº¦:', this.rotateAngle);
    console.info('[PlayerPage] æ˜¯å¦æ­£åœ¨æ—‹è½¬:', this.isRotating);

    if (!this.isRotating) {
      console.info('[PlayerPage] æ²¡æœ‰åœ¨æ—‹è½¬ï¼Œæ— éœ€åœæ­¢');
      return;
    }

    console.info('[PlayerPage] åœæ­¢æ—‹è½¬åŠ¨ç”»');
    this.isRotating = false;

    // åœæ­¢åŠ¨ç”»ï¼Œä¿æŒå½“å‰è§’åº¦
    animateTo({ duration: 0 }, () => {
      // ä¸é‡ç½®è§’åº¦ï¼Œä¿æŒå½“å‰ä½ç½®
      console.info('[PlayerPage] åŠ¨ç”»å·²åœæ­¢ï¼Œä¿æŒè§’åº¦:', this.rotateAngle);
    });
  }


  onTimeChange(): void {
    this.updateLyricHighlight();
  }

  async loadLyrics(): Promise<void> {
    if (!this.currentSong) {
      return;
    }

    try {
      const lyricData = await MusicApiService.getLyric(
        this.currentSong.source,
        this.currentSong.lyricId || this.currentSong.id
      );

      if (lyricData && lyricData.lyric) {
        this.lyrics = LyricParser.parse(lyricData.lyric);
        console.info('[PlayerPage] æ­Œè¯åŠ è½½æˆåŠŸï¼Œè¡Œæ•°:', this.lyrics.length);
      } else {
        this.lyrics = [];
        console.info('[PlayerPage] æ²¡æœ‰æ­Œè¯æ•°æ®');
      }
    } catch (error) {
      const err = error as Error;
      console.error('[PlayerPage] åŠ è½½æ­Œè¯å¤±è´¥:', err.message);
      this.lyrics = [];
    }
  }

  updateLyricHighlight(): void {
    if (this.lyrics.length === 0) {
      return;
    }

    const newIndex = LyricParser.getCurrentIndex(this.lyrics, this.currentTime);

    if (newIndex !== this.currentLyricIndex) {
      this.currentLyricIndex = newIndex;

      if (newIndex >= 0 && !this.isUserDragging) {
        this.scroller.scrollToIndex(newIndex, true, ScrollAlign.CENTER);
      }
    }
  }

  formatTime(seconds: number): string {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }

  togglePlay(): void {
    console.info('[PlayerPage] ===== åˆ‡æ¢æ’­æ”¾/æš‚åœ =====');
    AudioPlayerService.getInstance().togglePlay();
  }

  previousSong(): void {
    console.info('[PlayerPage] ===== ç‚¹å‡»ä¸Šä¸€æ›² =====');
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);
    console.info('[PlayerPage] æ’­æ”¾åˆ—è¡¨é•¿åº¦:', this.playlist.length);

    if (this.currentIndex > 0) {
      const prevIndex = this.currentIndex - 1;
      const prevSong = this.playlist[prevIndex];

      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²:', prevSong.name);
      console.info('[PlayerPage] ç›®æ ‡ç´¢å¼•:', prevIndex);
      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²ID:', prevSong.id);

      AudioPlayerService.getInstance().play(prevSong, this.playlist, prevIndex)
        .then(() => {
          console.info('[PlayerPage] âœ… æ’­æ”¾ä¸Šä¸€é¦–æˆåŠŸ');
        })
        .catch((error: Error) => {
          console.error('[PlayerPage] âŒ æ’­æ”¾ä¸Šä¸€é¦–å¤±è´¥:', error.message);
          promptAction.showToast({ message: 'æ’­æ”¾å¤±è´¥' });
        });
    } else {
      console.warn('[PlayerPage] å·²ç»æ˜¯ç¬¬ä¸€é¦–æ­Œæ›²');
      promptAction.showToast({ message: 'å·²ç»æ˜¯ç¬¬ä¸€é¦–æ­Œæ›²' });
    }
  }

  nextSong(): void {
    console.info('[PlayerPage] ===== ç‚¹å‡»ä¸‹ä¸€æ›² =====');
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);
    console.info('[PlayerPage] æ’­æ”¾åˆ—è¡¨é•¿åº¦:', this.playlist.length);

    if (this.currentIndex < this.playlist.length - 1) {
      const nextIndex = this.currentIndex + 1;
      const nextSong = this.playlist[nextIndex];

      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²:', nextSong.name);
      console.info('[PlayerPage] ç›®æ ‡ç´¢å¼•:', nextIndex);
      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²ID:', nextSong.id);

      AudioPlayerService.getInstance().play(nextSong, this.playlist, nextIndex)
        .then(() => {
          console.info('[PlayerPage] âœ… æ’­æ”¾ä¸‹ä¸€é¦–æˆåŠŸ');
        })
        .catch((error: Error) => {
          console.error('[PlayerPage] âŒ æ’­æ”¾ä¸‹ä¸€é¦–å¤±è´¥:', error.message);
          promptAction.showToast({ message: 'æ’­æ”¾å¤±è´¥' });
        });
    } else {
      console.warn('[PlayerPage] å·²ç»æ˜¯æœ€åä¸€é¦–æ­Œæ›²');
      promptAction.showToast({ message: 'å·²ç»æ˜¯æœ€åä¸€é¦–æ­Œæ›²' });
    }
  }

  onProgressChange(value: number): void {
    this.isUserDragging = true;
    AudioPlayerService.getInstance().seek(value);
    setTimeout(() => {
      this.isUserDragging = false;
    }, 500);
  }

  changeQuality(quality: number): void {
    console.info('[PlayerPage] ===== åˆ‡æ¢éŸ³è´¨ =====');
    console.info('[PlayerPage] æ–°éŸ³è´¨:', quality);

    this.selectedQuality = quality;
    AudioPlayerService.getInstance().setQuality(quality);

    if (this.currentSong) {
      const currentTime = this.currentTime;
      AudioPlayerService.getInstance().play(this.currentSong, this.playlist, this.currentIndex)
        .then(() => {
          AudioPlayerService.getInstance().seek(currentTime);
          promptAction.showToast({ message: 'éŸ³è´¨åˆ‡æ¢æˆåŠŸ' });
        })
        .catch((error: Error) => {
          console.error('[PlayerPage] åˆ‡æ¢éŸ³è´¨å¤±è´¥:', error.message);
          promptAction.showToast({ message: 'éŸ³è´¨åˆ‡æ¢å¤±è´¥' });
        });
    }
    this.showQualityMenu = false;
  }

  aboutToDisappear(): void {
    console.info('[PlayerPage] ===== é¡µé¢é”€æ¯ =====');
    this.stopRotation();
  }

  build() {
    Column() {
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor('#F5F5F5')
        .onClick(() => {
          try {
            router.back();
          } catch (error) {
            const err = error as Error;
            console.error('[PlayerPage] è¿”å›å¤±è´¥:', err.message);
          }
        })

        Text(this.currentSong?.name || 'æ’­æ”¾å™¨')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ left: 12, right: 12 })

        Button({ type: ButtonType.Normal }) {
          Row() {
            Text(this.selectedQuality === 128 ? 'æ ‡å‡†'
              : this.selectedQuality === 192 ? 'è¾ƒé«˜'
                : this.selectedQuality === 320 ? 'é«˜å“'
                  : 'æ— æŸ')
              .fontSize(12)
              .fontColor('#FF6B6B')
            Text(' â–¼')
              .fontSize(10)
              .fontColor('#FF6B6B')
          }
        }
        .width(80)
        .height(36)
        .backgroundColor('#FFF0F0')
        .borderRadius(18)
        .onClick(() => {
          this.showQualityMenu = !this.showQualityMenu;
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .zIndex(10)

      if (this.showQualityMenu) {
        Column() {
          Button('æ ‡å‡† 128K')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 128 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 128 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(128))

          Divider().height(1).color($r('sys.color.ohos_id_color_list_separator'))

          Button('è¾ƒé«˜ 192K')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 192 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 192 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(192))

          Divider().height(1).color($r('sys.color.ohos_id_color_list_separator'))

          Button('é«˜å“ 320K')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 320 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 320 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(320))

          Divider().height(1).color($r('sys.color.ohos_id_color_list_separator'))

          Button('æ— æŸ FLAC')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 999 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 999 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(999))
        }
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 16, color: '#1F000000' })
        .position({ x: '5%', y: 70 })
        .zIndex(20)
      }

      Scroll() {
        Column() {
          Stack() {
            if (this.coverUrl) {
              Image(this.coverUrl)
                .width(280)
                .height(280)
                .borderRadius(140)
                .backgroundColor($r('sys.color.ohos_id_color_background'))
                .rotate({
                  x: 0,
                  y: 0,
                  z: 1,
                  angle: this.rotateAngle
                })
                .shadow({
                  radius: 20,
                  color: '#40000000',
                  offsetX: 0,
                  offsetY: 10
                })
            } else {
              Column() {
                Text('ğŸµ')
                  .fontSize(80)
                  .opacity(0.3)
              }
              .width(280)
              .height(280)
              .borderRadius(140)
              .backgroundColor($r('sys.color.ohos_id_color_background'))
              .justifyContent(FlexAlign.Center)
              .rotate({
                x: 0,
                y: 0,
                z: 1,
                angle: this.rotateAngle
              })
              .shadow({
                radius: 20,
                color: '#40000000',
                offsetX: 0,
                offsetY: 10
              })
            }

            Column()
              .width(50)
              .height(50)
              .borderRadius(25)
              .backgroundColor('#FFFFFF')
              .shadow({
                radius: 5,
                color: '#60000000',
                offsetX: 0,
                offsetY: 0
              })
          }
          .width(280)
          .height(280)
          .margin({ top: 40, bottom: 30 })

          Text(this.currentSong?.name || 'æœªçŸ¥æ­Œæ›²')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('90%')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 8 })

          Text(this.currentSong
            ? `${this.currentSong.artist} Â· ${this.currentSong.album || 'æœªçŸ¥ä¸“è¾‘'}`
            : 'æœªçŸ¥æ­Œæ‰‹')
            .fontSize(14)
            .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('90%')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 30 })

          Column() {
            Slider({
              value: this.currentTime,
              min: 0,
              max: this.duration || 100,
              step: 1,
              style: SliderStyle.OutSet
            })
              .blockColor('#FF6B6B')
              .trackColor('#EEEEEE')
              .selectedColor('#FF6B6B')
              .showSteps(false)
              .showTips(false)
              .onChange((value: number) => {
                this.onProgressChange(value);
              })

            Row() {
              Text(this.formatTime(this.currentTime))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))

              Text(this.formatTime(this.duration))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ top: 8 })
          }
          .width('90%')
          .margin({ bottom: 30 })

          Row() {
            Button({ type: ButtonType.Circle }) {
              Text('â®')
                .fontSize(24)
                .fontColor('#333333')
            }
            .width(50)
            .height(50)
            .backgroundColor('#F5F5F5')
            .enabled(this.currentIndex > 0)
            .opacity(this.currentIndex > 0 ? 1 : 0.5)
            .onClick(() => {
              this.previousSong();
            })

            Button({ type: ButtonType.Circle }) {
              Text(this.playState === PlayState.PLAYING ? 'â¸' : 'â–¶')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }
            .width(70)
            .height(70)
            .backgroundColor('#FF6B6B')
            .margin({ left: 30, right: 30 })
            .onClick(() => {
              this.togglePlay();
            })

            Button({ type: ButtonType.Circle }) {
              Text('â­')
                .fontSize(24)
                .fontColor('#333333')
            }
            .width(50)
            .height(50)
            .backgroundColor('#F5F5F5')
            .enabled(this.currentIndex < this.playlist.length - 1)
            .opacity(this.currentIndex < this.playlist.length - 1 ? 1 : 0.5)
            .onClick(() => {
              this.nextSong();
            })
          }
          .margin({ bottom: 40 })

          Column() {
            Row() {
              Text('æ­Œè¯')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)

              Text(`${this.currentIndex + 1} / ${this.playlist.length}`)
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .margin({ left: 8 })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ bottom: 16 })

            if (this.lyrics.length > 0) {
              List({ space: 12, scroller: this.scroller }) {
                ForEach(this.lyrics, (lyric: LyricLine, index: number) => {
                  ListItem() {
                    Text(lyric.text)
                      .fontSize(this.currentLyricIndex === index ? 18 : 14)
                      .fontColor(this.currentLyricIndex === index ? '#FF6B6B' : '#999999')
                      .fontWeight(this.currentLyricIndex === index ? FontWeight.Bold : FontWeight.Normal)
                      .textAlign(TextAlign.Center)
                      .width('100%')
                      .transition({ type: TransitionType.All, opacity: 1 })
                      .animation({ duration: 300 })
                  }
                }, (lyric: LyricLine) => lyric.time.toString())
              }
              .width('100%')
              .height(300)
              .scrollBar(BarState.Off)
            } else {
              Column() {
                Text('ğŸµ')
                  .fontSize(40)
                  .opacity(0.3)
                Text('æš‚æ— æ­Œè¯')
                  .fontSize(14)
                  .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                  .margin({ top: 12 })
              }
              .width('100%')
              .height(300)
              .justifyContent(FlexAlign.Center)
            }
          }
          .width('90%')
          .padding(20)
          .backgroundColor('#F9F9F9')
          .borderRadius(12)
          .margin({ bottom: 20 })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}
